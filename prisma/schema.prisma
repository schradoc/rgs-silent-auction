generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Bidder {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  tableNumber  String
  emailVerified Boolean @default(false)
  verificationCode String?
  isMockData   Boolean  @default(false) // Flag for generated test data
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Contact & Notification preferences (Phase 2)
  phone            String?
  whatsappOptIn    Boolean @default(false)
  smsOptIn         Boolean @default(false)
  emailOptIn       Boolean @default(true)
  notificationPref NotificationChannel @default(EMAIL)

  // Passwordless auth (Phase 2)
  magicLinkToken   String?
  magicLinkExpires DateTime?
  otpCode          String?
  otpExpires       DateTime?

  bids          Bid[]
  winners       Winner[]
  favorites     Favorite[]
  notifications Notification[]
}

model Prize {
  id                    String   @id @default(cuid())
  slug                  String   @unique
  title                 String
  shortDescription      String
  fullDescription       String   @db.Text
  donorName             String
  minimumBid            Int      // In HKD
  currentHighestBid     Int      @default(0)
  category              Category
  multiWinnerEligible   Boolean  @default(false)
  multiWinnerSlots      Int?     // null means unlimited (for pledges)
  validUntil            DateTime
  imageUrl              String   // Primary image (kept for backwards compat)
  terms                 String?  @db.Text
  displayOrder          Int      @default(0)
  isActive              Boolean  @default(true)

  // For grouped prizes like maps
  parentPrizeId         String?
  parentPrize           Prize?   @relation("PrizeVariants", fields: [parentPrizeId], references: [id])
  variants              Prize[]  @relation("PrizeVariants")

  // For tiered prizes like pledges
  tierLevel             Int?     // 1, 2, 3, 4 for pledge tiers

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  bids                  Bid[]
  winners               Winner[]
  favorites             Favorite[]
  images                PrizeImage[]

  @@index([isActive, parentPrizeId])
}

model PrizeImage {
  id        String   @id @default(cuid())
  url       String
  alt       String?
  order     Int      @default(0)
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())

  prizeId   String
  prize     Prize    @relation(fields: [prizeId], references: [id], onDelete: Cascade)

  @@index([prizeId])
}

enum Category {
  HISTORIC_ITEMS
  EXPERIENCES
  TRAVEL
  DINING
  PLEDGES
}

model Bid {
  id        String   @id @default(cuid())
  amount    Int      // In HKD
  status    BidStatus @default(ACTIVE)
  isMockData Boolean  @default(false) // Flag for generated test data
  createdAt DateTime @default(now())

  bidderId  String
  bidder    Bidder   @relation(fields: [bidderId], references: [id], onDelete: Cascade)

  prizeId   String
  prize     Prize    @relation(fields: [prizeId], references: [id])

  // Helper tracking (Phase 2)
  helperId   String?
  helper     Helper?  @relation(fields: [helperId], references: [id])
  isPaperBid Boolean  @default(false)

  winner    Winner?
  paperBid  PaperBid?

  @@index([prizeId, amount])
  @@index([prizeId, status])
  @@index([bidderId])
  @@index([helperId])
  @@index([status])
}

enum BidStatus {
  ACTIVE
  OUTBID
  WINNING
  WON
  LOST
}

model Winner {
  id         String   @id @default(cuid())
  acceptedAt DateTime @default(now())

  bidId      String   @unique
  bid        Bid      @relation(fields: [bidId], references: [id])

  prizeId    String
  prize      Prize    @relation(fields: [prizeId], references: [id])

  bidderId   String
  bidder     Bidder   @relation(fields: [bidderId], references: [id])

  @@index([prizeId])
}

// ==========================================
// Auction State Machine
// ==========================================

enum AuctionState {
  DRAFT      // Building out prizes, mock data okay
  TESTING    // Real data, testing flows
  PRELAUNCH  // Public preview, no bidding yet
  LIVE       // Bidding open
  CLOSED     // Event over, winners being confirmed
}

model AuctionSettings {
  id              String       @id @default("settings")
  auctionState    AuctionState @default(DRAFT)
  auctionEndTime  DateTime?
  auctionStartTime DateTime?
  isAuctionOpen   Boolean      @default(false) // Derived from state, kept for backwards compat
  updatedAt       DateTime     @updatedAt
}

// ==========================================
// Display Settings for Live Page
// ==========================================

model DisplaySettings {
  id                   String   @id @default("display")
  showDonorNames       Boolean  @default(true)   // Show donor names on live/public pages
  showBidderNames      Boolean  @default(false)  // false = show "Table X" only on live display
  featuredRotationSecs Int      @default(8)      // Seconds between featured prize rotation
  customQrUrl          String?                   // Optional custom URL for QR codes
  updatedAt            DateTime @updatedAt
}

// ==========================================
// Admin User System
// ==========================================

enum AdminRole {
  OWNER     // Full access, can manage all admins
  ADMIN     // Can manage employees, almost full access
  EMPLOYEE  // Limited access, can't change state or manage users
}

model AdminUser {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String?   // Optional - magic links preferred
  name         String
  role         AdminRole @default(EMPLOYEE)
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  invitedById  String?   // Who invited this user
  invitedBy    AdminUser? @relation("AdminInvites", fields: [invitedById], references: [id])
  invitees     AdminUser[] @relation("AdminInvites")

  auditLogs    AuditLog[]
  invitations  AdminInvitation[]
}

model AdminSession {
  id          String   @id @default(cuid())
  token       String   @unique
  adminUserId String?  // null for setup sessions
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  @@index([expiresAt])
}

model AdminInvitation {
  id           String    @id @default(cuid())
  email        String
  role         AdminRole @default(EMPLOYEE)
  token        String    @unique
  expiresAt    DateTime
  acceptedAt   DateTime?
  createdAt    DateTime  @default(now())

  invitedById  String
  invitedBy    AdminUser @relation(fields: [invitedById], references: [id])

  @@index([email])
  @@index([token])
}

// ==========================================
// Audit Log for Admin Actions
// ==========================================

model AuditLog {
  id          String    @id @default(cuid())
  action      String    // e.g., "PRIZE_CREATED", "STATE_CHANGED", "WINNER_CONFIRMED"
  entityType  String?   // e.g., "Prize", "Bid", "Settings"
  entityId    String?
  details     String?   @db.Text // JSON details
  adminUserId String?
  adminUser   AdminUser? @relation(fields: [adminUserId], references: [id])
  ipAddress   String?
  createdAt   DateTime  @default(now())

  @@index([adminUserId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// ==========================================
// Phase 2: Helper System & Gamification
// ==========================================

model Helper {
  id          String   @id @default(cuid())
  name        String
  pin         String   // Simple 4-digit PIN for quick login
  avatarColor String   // For visual identification (hex color)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  bidsPrompted Bid[]      // Bids this helper facilitated
  paperBids    PaperBid[]

  @@index([pin, isActive])
}

// ==========================================
// Phase 2: Paper Bid System
// ==========================================

model PaperBid {
  id             String   @id @default(cuid())
  imageUrl       String?  // Stored photo of paper bid
  tableNumber    String
  bidderName     String
  prizeId        String
  amount         Int
  email          String?
  phone          String?
  notifyIfOutbid Boolean  @default(false)

  processedAt DateTime @default(now())
  helperId    String
  helper      Helper   @relation(fields: [helperId], references: [id])

  // Links to actual bid once processed
  bidId String? @unique
  bid   Bid?    @relation(fields: [bidId], references: [id])

  @@index([helperId])
  @@index([prizeId])
}

// ==========================================
// Phase 2: Notification System
// ==========================================

enum NotificationChannel {
  EMAIL
  SMS
  WHATSAPP
}

enum NotificationType {
  OUTBID
  WINNING
  AUCTION_CLOSING
  WON
}

model Notification {
  id        String              @id @default(cuid())
  type      NotificationType
  channel   NotificationChannel
  bidderId  String
  bidder    Bidder              @relation(fields: [bidderId], references: [id])
  prizeId   String?
  message   String              @db.Text
  sentAt    DateTime            @default(now())
  delivered Boolean             @default(false)
  error     String?

  @@index([bidderId])
  @@index([prizeId])
}

// ==========================================
// Phase 2: Watchlist/Favorites
// ==========================================

model Favorite {
  id        String   @id @default(cuid())
  bidderId  String
  bidder    Bidder   @relation(fields: [bidderId], references: [id])
  prizeId   String
  prize     Prize    @relation(fields: [prizeId], references: [id])
  createdAt DateTime @default(now())

  @@unique([bidderId, prizeId])
  @@index([bidderId])
  @@index([prizeId])
}
